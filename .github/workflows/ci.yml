name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Dashboard Tests and Build
  dashboard-tests:
    name: Dashboard Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json
        
    - name: Install dependencies
      run: |
        cd dashboard
        npm ci
        
    - name: Run linting
      run: |
        cd dashboard
        npm run lint
        
    - name: Run unit tests
      run: |
        cd dashboard
        npm run test:ci
        
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./dashboard/coverage/lcov.info
        flags: dashboard
        name: dashboard-coverage
        
    - name: Build dashboard
      run: |
        cd dashboard
        npm run build
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dashboard-build
        path: dashboard/.next/
        retention-days: 7

  # E2E Tests
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json
        
    - name: Install dependencies
      run: |
        cd dashboard
        npm ci
        
    - name: Install Playwright
      run: |
        cd dashboard
        npx playwright install --with-deps
        
    - name: Build application
      run: |
        cd dashboard
        npm run build
        
    - name: Run E2E tests
      run: |
        cd dashboard
        npm run test:e2e
        
    - name: Upload E2E test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: playwright-report
        path: dashboard/playwright-report/
        retention-days: 7

  # Hardware Firmware Tests
  hardware-tests:
    name: Hardware Firmware Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        echo "$HOME/bin" >> $GITHUB_PATH
        
    - name: Validate Arduino code syntax
      run: |
        cd hardware/esp32_firmware
        arduino-cli compile --fqbn esp32:esp32:esp32 esp32_tracker.ino --dry-run
        
    - name: Check firmware configuration
      run: |
        cd hardware/esp32_firmware
        # Check for required configuration variables
        if ! grep -q "DEVICE_ID" esp32_tracker.ino; then
          echo "ERROR: DEVICE_ID not found in firmware"
          exit 1
        fi
        if ! grep -q "SUPABASE_URL" esp32_tracker.ino; then
          echo "ERROR: SUPABASE_URL not found in firmware"
          exit 1
        fi

  # Database Schema Validation
  database-validation:
    name: Database Schema Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PostgreSQL
      uses: Harmon758/postgresql-action@v1
      with:
        postgresql version: '14'
        postgresql db: test_db
        postgresql user: test_user
        postgresql password: test_password
        
    - name: Install PostGIS
      run: |
        sudo apt-get update
        sudo apt-get install -y postgresql-14-postgis-3
        
    - name: Validate database schema
      run: |
        PGPASSWORD=test_password psql -h localhost -U test_user -d test_db -f supabase/migrations/001_create_trackers_table.sql
        
    - name: Test database schema
      run: |
        PGPASSWORD=test_password psql -h localhost -U test_user -d test_db -c "
          -- Test table creation
          SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'trackers';
          
          -- Test indexes
          SELECT COUNT(*) FROM pg_indexes WHERE tablename = 'trackers';
          
          -- Test triggers
          SELECT COUNT(*) FROM information_schema.triggers WHERE event_object_table = 'trackers';
        "

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run npm audit
      run: |
        cd dashboard
        npm audit --audit-level=high
        
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v4
      with:
        languages: javascript
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4

  # Build and Deploy (only on main branch)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [dashboard-tests, e2e-tests, hardware-tests, database-validation, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: dashboard/package-lock.json
        
    - name: Install dependencies
      run: |
        cd dashboard
        npm ci
        
    - name: Build for production
      run: |
        cd dashboard
        npm run build
        
    - name: Deploy to Vercel (example)
      uses: amondnet/vercel-action@v20
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./dashboard
        
    - name: Deploy Supabase Edge Functions
      run: |
        # Install Supabase CLI
        curl -fsSL https://supabase.com/install.sh | sh
        echo "$HOME/.supabase/bin" >> $GITHUB_PATH
        
        # Deploy edge functions
        cd supabase/functions
        supabase functions deploy tracker-update --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}

  # Notification
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
    - name: Notify on success
      if: needs.deploy.result == 'success'
      run: |
        echo "✅ Deployment successful!"
        
    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Deployment failed!"
